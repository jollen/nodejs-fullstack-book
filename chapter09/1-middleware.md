# 9.1 Express Middleware æµç¨‹æ§åˆ¶

å»¶çºŒç¬¬ 8 ç« æ‰€å»ºç«‹çš„è§€å¿µï¼ŒExpress.js ä¸­çš„ Middleware ä¸åƒ…èƒ½é‡å°ã€Œæ‰€æœ‰è«‹æ±‚ã€å…¨åŸŸæ””æˆªï¼Œä¹Ÿèƒ½è¨­è¨ˆç‚ºã€Œç‰¹å®š URLã€å°ˆå±¬çš„æµç¨‹å®ˆé–€äººã€‚

è¦çœŸæ­£æŒæ¡ Middleware çš„é‹ä½œæ–¹å¼ï¼Œæœ€ä½³æ–¹æ³•å°±æ˜¯å¯¦ä½œä¸€å€‹å…·æœ‰æµç¨‹é‚è¼¯çš„æ¡ˆä¾‹ï¼š**ç‚º ********************************`/hello`******************************** é é¢åŠ ä¸Šå¯†ç¢¼ä¿è­·ã€‚**

> Express ä¸­çš„ Middlewareï¼Œä¸åªæ˜¯ã€Œæ’å…¥ä¸€æ®µé©—è­‰ã€ï¼Œè€Œæ˜¯å°‡èªå¢ƒè™•ç†æ¨¡çµ„åŒ–ã€‚
> å®ƒè®“æµç¨‹ä¸å†æ˜¯ `if...else` ç–ŠåŠ ï¼Œè€Œæ˜¯æ¸…æ¥šåˆ†å·¥çš„èªæ„éˆæ¢â€”â€”
> èª°è™•ç†é©—è­‰ï¼Ÿèª°è™•ç†å‰ç½®è³‡æ–™ï¼Ÿèª°å›æ‡‰é é¢ï¼Ÿ
> æ¯å±¤ Middleware éƒ½æ˜¯ä¸€å€‹èªæ„è§’è‰²ã€‚é€™æ˜¯èªè¨€é©…å‹•æ¶æ§‹çš„é››å½¢ã€‚

## Middleware æ˜¯ä»€éº¼ï¼Ÿ

åœ¨ Express ä¸­ï¼ŒMiddleware æ˜¯ä¸€ç¨®ã€Œè«‹æ±‚è™•ç†å‡½æ•¸ã€ï¼Œå…·æœ‰ `(req, res, next)` ä¸‰å€‹åƒæ•¸ã€‚
å®ƒçš„ç”¨é€”ä¸æ˜¯ç”¢ç”Ÿé é¢ï¼Œè€Œæ˜¯ï¼š

* åœ¨è«‹æ±‚é€åˆ°è·¯ç”±å‰ã€Œé€²è¡Œè™•ç†ã€
* æ±ºå®šæ˜¯å¦è¦ç¹¼çºŒæµç¨‹ï¼ˆå‘¼å« `next()`ï¼‰æˆ–ç›´æ¥å›æ‡‰ï¼ˆå‘¼å« `res.send()`ï¼‰
* å¯ä»¥è¢«ã€Œå †ç–Šã€èµ·ä¾†ï¼Œå½¢æˆä¸€æ¢ä¸²è¡Œçš„åŸ·è¡Œéˆ

Express æ‡‰ç”¨çš„æ•´é«”æ¶æ§‹ï¼Œå…¶å¯¦æ˜¯ä¸€ä¸² Middleware ä¸²æ¥èµ·ä¾†çš„èªæ„æµç¨‹ã€‚

## Step 1ï¼šåœ¨ Routing ä¸­åŠ å…¥ Middleware

é‡å°ç‰¹å®š URL åŠ å…¥ Middlewareï¼Œå¯é€é `app.get()` çš„ç¬¬äºŒå€‹åƒæ•¸å®Œæˆã€‚

```js
app.get('/hello', function (req, res, next) {
  // é€™è£¡æ˜¯ Middleware
}, hello.index);
```

* ç¬¬äºŒå€‹åƒæ•¸æ˜¯ä¸€å€‹ Middleware å‡½æ•¸ï¼Œæœƒåœ¨é€²å…¥ `hello.index` å‰åŸ·è¡Œ
* è‹¥è©²å‡½æ•¸æœªå‘¼å« `next()`ï¼Œè«‹æ±‚å°‡ç„¡æ³•ç¹¼çºŒï¼Œç•«é¢æœƒå¡ä½

ä¾‹å¦‚ä½ æƒ³ç”¨æœ€ç°¡å–®çš„æ–¹å¼ä¾†é©—è­‰å¯†ç¢¼ï¼Œå¯é€é Query String å‚³å…¥å¯†ç¢¼ï¼š

```js
app.get('/hello', function (req, res, next) {
  if (req.query.passwd === '123456') {
    next();
  } else {
    res.status(401).send('Unauthorized');
  }
}, hello.index);
```

é€™æ˜¯ Middleware æœ€åŸºæœ¬çš„èªæ„ï¼šã€Œå…ˆæª¢æŸ¥æ¢ä»¶ï¼Œç¬¦åˆå°±ç¹¼çºŒï¼Œä¸ç¬¦å°±çµ‚æ­¢ã€ã€‚

ğŸ“Œ å¯†ç¢¼å¯«åœ¨ç¶²å€ä¸Šä¸¦ä¸å®‰å…¨ï¼Œé€™è£¡åƒ…ä½œç‚º Middleware å¯¦ä½œç¤ºç¯„ã€‚

## Step 2ï¼šèªè­˜ Middleware çš„æµç¨‹æ§åˆ¶

è‹¥ä½ æ›¾çœç•¥ `next()`ï¼Œå°±æœƒç™¼ç¾ç€è¦½å™¨ä¸€ç›´è½‰åœˆåœˆã€‚

Express çš„è«‹æ±‚è™•ç†éˆæ˜¯ä¸²æ¥å¼çš„ï¼š

```
[Request]
   â†“
Middleware A (é©—è­‰)
   â†“ next()
Middleware B (è¨­å®š)
   â†“ next()
Handler (é€å‡ºé é¢)
   â†“
[Response]
```

æ¯ä¸€å±¤åªåšä¸€ä»¶äº‹ï¼Œç„¶å¾Œäº¤æ£’ã€‚

ğŸ§­ **Debug æç¤ºï¼š**
è‹¥ Middleware å‡½æ•¸æœªå‘¼å« `next()` æˆ– `res.send()`ï¼ŒExpress å°‡ç„¡æ³•ç¹¼çºŒè™•ç†è«‹æ±‚ï¼Œç€è¦½å™¨å°‡æŒçºŒç­‰å¾…å›æ‡‰ã€‚
é–‹ç™¼æ™‚å¯åŠ ä¸Š log è¨Šæ¯ï¼Œç¢ºèªæµç¨‹æ˜¯å¦å¡åœ¨æŸä¸€å±¤ï¼š

```js
app.use((req, res, next) => {
  console.log('[é€²å…¥ Middleware]');
  next();
});
```

## å…¨åŸŸ Middlewareï¼šæ‰€æœ‰è«‹æ±‚éƒ½æœƒç¶“é

ä½¿ç”¨ `app.use()` å¯è¨»å†Šã€Œå…¨ç«™é©ç”¨ã€çš„ Middlewareï¼Œä¾‹å¦‚è¨˜éŒ„è«‹æ±‚æ—¥èªŒã€è¨­å®š CORS æ¨™é ­ã€é©—è­‰ API token ç­‰ã€‚

```js
app.use((req, res, next) => {
  console.log(`[${new Date().toISOString()}] ${req.method} ${req.url}`);
  next();
});
```

é€™æ®µç¨‹å¼ç¢¼å°‡åœ¨æ¯ä¸€å€‹è«‹æ±‚é€²å…¥æ‡‰ç”¨æ™‚è¢«åŸ·è¡Œï¼Œç„¡è«–æ˜¯ `/hello` æˆ– `/users`ï¼Œçš†æœƒç¶“éã€‚

## Step 3ï¼šæ‹†åˆ†æµç¨‹é‚è¼¯

ç‚ºäº†è®“æµç¨‹æ›´æ¸…æ™°ã€çµæ§‹æ›´æ˜ç¢ºï¼Œæˆ‘å€‘å¯ä»¥æ‹†åˆ†ç‚ºå¤šå€‹ç¨ç«‹çš„ Middlewareï¼š

```js
app.get('/hello', hello.auth);
app.get('/hello', hello.config);
app.get('/hello', hello.index);
```

é€™è¡¨ç¤ºï¼š

1. `/hello` çš„ç¬¬ä¸€å±¤è™•ç†æ˜¯é©—è­‰èº«ä»½ï¼ˆauthï¼‰
2. ç¬¬äºŒå±¤åŸ·è¡Œé é¢å‰çš„æº–å‚™ï¼ˆconfigï¼‰
3. ç¬¬ä¸‰å±¤æ‰æ˜¯è¼¸å‡ºç•«é¢ï¼ˆindexï¼‰

å°æ‡‰çš„ `hello.js` å¦‚ä¸‹ï¼š

```js
exports.auth = function(req, res, next) {
  if (req.query.passwd === '123456') {
    next();
  } else {
    res.status(401).send('Unauthorized');
  }
};

exports.config = function(req, res, next) {
  console.log('Preprocessing step...');
  next();
};

exports.index = function(req, res) {
  res.render('hello');
};
```

é€™å°±æ˜¯ **Middleware çš„æ ¸å¿ƒè¨­è¨ˆæ€ç¶­**ï¼šä¸€å±¤ä¸€è²¬ä»»ï¼Œæ¯å±¤åªè™•ç†ä¸€ä»¶äº‹ã€‚

## Step 4ï¼šç³»çµ±è§€è¦–è§’ï¼šMiddleware å°±æ˜¯èªå¢ƒæ§åˆ¶éˆ

å¾æ¶æ§‹ä¸Šä¾†çœ‹ï¼Œæ¯ä¸€å€‹ `app.get()` å®£å‘Šçš„ Middleware éƒ½æ˜¯ä¸€å€‹ã€Œå¯æ’æ‹”çš„èªæ„æ¨¡çµ„ã€ï¼Œä½ å¯ä»¥ç”¨ä¾†ï¼š

* é©—è­‰ç™»å…¥
* è¨˜éŒ„æ—¥èªŒ
* å‰ç½®è™•ç†è³‡æ–™
* æ³¨å…¥æ¬Šé™è¨­å®š
* æ””æˆªéŒ¯èª¤æˆ–åµéŒ¯è³‡è¨Š

é€™è®“ URL çš„èƒŒå¾Œä¸å†åªæ˜¯ã€Œå°æ‡‰ç•«é¢ã€ï¼Œè€Œæ˜¯ä¸€æ¢èªæ„æµç¨‹éˆã€‚ä½ ä¸å¿…åœ¨ç•«é¢è™•ç†é‚è¼¯ä¸­å¡å…¥æ‰€æœ‰æ¢ä»¶ï¼Œè€Œæ˜¯ç”¨ Middleware æŠŠèªå¢ƒé‚è¼¯æ‹†æˆå¤šæ®µç¨ç«‹æ¨¡çµ„ã€‚

é€™ä¸åªæ˜¯ç¨‹å¼è¨­è¨ˆæŠ€å·§ï¼Œè€Œæ˜¯ç³»çµ±è¨­è¨ˆè§€ã€‚

ğŸ“‰ **Middleware æ¶æ§‹ç¸½è¦½åœ–**ï¼š

```
[Client Request]
      â†“
  app.use()    â† å…¨åŸŸ Middleware
      â†“
app.get('/hello', authMiddleware)
      â†“
      configMiddleware
      â†“
      indexHandler
      â†“
[Client Response]
```

## Step 5ï¼šè£œå…… Basic èªè­‰ï¼ˆbasicAuthï¼‰èˆ‡ç¾ä»£æ›¿ä»£æ–¹æ¡ˆ

Express æ›¾å…§å»ºä¸€å€‹ `basicAuth()` ä¸­ä»‹å±¤ï¼Œå¯ç”¨ä¾†å¿«é€ŸåŠ ä¸Š HTTP èªè­‰æ¡†ã€‚ä½†å› å®‰å…¨æ€§èˆ‡å½ˆæ€§ä¸è¶³ï¼Œç¾å·²ç§»å‡ºæ ¸å¿ƒæ¨¡çµ„ï¼Œéœ€å¦è¡Œå®‰è£ï¼š

```bash
npm install basic-auth-connect
```

ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š

```js
const basicAuth = require('basic-auth-connect');

app.get('/hello', basicAuth('jollen', 'abcdef'));
app.get('/hello', hello.index);
```

ğŸ“Œ æ³¨æ„ï¼šBasic èªè­‰åƒ…é©ç”¨æ–¼é–‹ç™¼æ¸¬è©¦ã€‚æ­£å¼ç’°å¢ƒå»ºè­°ä½¿ç”¨ sessionã€token æˆ– JWT ç­‰é©—è­‰æ©Ÿåˆ¶ã€‚

## å°çµï¼šMiddleware æ˜¯é‚è¼¯åˆ†å±¤çš„æ¬Šé™è¨­è¨ˆ

æœ¬ç¯€å±•ç¤ºäº† Express ä¸­ Middleware çš„å¯¦éš›é‹ä½œèˆ‡è¨­è¨ˆå¿ƒæ³•ã€‚æ¯å€‹ Middleware éƒ½åƒæ˜¯ä¸€é“ã€Œèªæ„éæ¿¾å™¨ã€ï¼Œæ±ºå®šæ˜¯å¦æ”¾è¡Œã€æ˜¯å¦è½‰äº¤ï¼Œæˆ–æ˜¯ä¸­æ­¢æµç¨‹å›æ‡‰éŒ¯èª¤ã€‚

é€™ä¹Ÿæ˜¯å¾ 8.5 ç¯€å»¶çºŒä¸‹ä¾†çš„é‡é»ï¼šMiddleware ä¸¦éè¼”åŠ©å…ƒä»¶ï¼Œè€Œæ˜¯èªå¢ƒæ§åˆ¶çš„ä¸»å¹¹ã€‚

ğŸ“Š **èªæ„è½‰æ›å°ç…§ï¼šå¾ if/else åˆ° Middleware çµæ§‹åŒ–é‚è¼¯**

| å‚³çµ± if...else ç¨‹å¼ç¢¼        | Express Middleware èªæ„çµæ§‹     |
| ----------------------- | --------------------------- |
| `if (!auth) return`     | `authMiddleware â†’ next()`   |
| `if (!configOK) return` | `configMiddleware â†’ next()` |
| `res.send()`            | `res.render()`ï¼ˆæœ€çµ‚ Handlerï¼‰  |

ä¸‹ä¸€ç¯€å°‡é€²ä¸€æ­¥å±•é–‹ View çš„å‹•æ…‹ç”Ÿæˆèˆ‡ Template Engine çš„ä½¿ç”¨ã€‚

---

Next: [9.2 MVC èˆ‡ HTML Template Engine](2-use.md)
